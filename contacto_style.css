document.addEventListener('DOMContentLoaded', () => {
  const user = JSON.parse(localStorage.getItem('user'));
  if (!user || user.role !== 'admin') {
    alert("Acceso denegado");
    window.location.href = 'login.html';
    return;
  }

  const eventTableBody = document.getElementById('eventTableBody');
  const createForm = document.getElementById('createEventForm');
  const editForm = document.getElementById('editEventForm');

  const createModal = new bootstrap.Modal(document.getElementById('createEventModal'));
  const editModal = new bootstrap.Modal(document.getElementById('editEventModal'));

  const loadEvents = async () => {
    const res = await fetch('http://localhost:3000/events');
    const events = await res.json();
    eventTableBody.innerHTML = '';

    events.forEach((event, index) => {
      eventTableBody.innerHTML += `
        <tr>
          <td>${index + 1}</td>
          <td><img src="${event.imageUrl || 'https://via.placeholder.com/80'}" class="thumbnail" style="width:80px"></td>
          <td>${event.title}</td>
          <td>${event.date}</td>
          <td>${event.capacity}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="openEditModal(${event.id})">Editar</button>
            <button class="btn btn-sm btn-danger ms-2" onclick="deleteEvent(${event.id})">Eliminar</button>
          </td>
        </tr>
      `;
    });
  };

  // Crear evento
  createForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const title = document.getElementById('title').value;
    const date = document.getElementById('date').value;
    const capacity = parseInt(document.getElementById('capacity').value);
    const imageUrl = document.getElementById('imageUrl').value;

    const newEvent = { title, date, capacity, imageUrl };

    await fetch('http://localhost:3000/events', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(newEvent)
    });

    createForm.reset();
    createModal.hide();
    loadEvents();
  });

  // Abrir modal de edición
  window.openEditModal = async (id) => {
    const res = await fetch(`http://localhost:3000/events/${id}`);
    const event = await res.json();

    document.getElementById('editId').value = event.id;
    document.getElementById('editTitle').value = event.title;
    document.getElementById('editDate').value = event.date;
    document.getElementById('editCapacity').value = event.capacity;
    document.getElementById('editImageUrl').value = event.imageUrl || '';

    editModal.show();
  };

  // Editar evento
  editForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('editId').value;
    const title = document.getElementById('editTitle').value;
    const date = document.getElementById('editDate').value;
    const capacity = parseInt(document.getElementById('editCapacity').value);
    const imageUrl = document.getElementById('editImageUrl').value;

    const updatedEvent = { title, date, capacity, imageUrl };

    await fetch(`http://localhost:3000/events/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updatedEvent)
    });

    editModal.hide();
    loadEvents();
  });

  // Eliminar evento
  window.deleteEvent = async (id) => {
    if (confirm("¿Deseas eliminar este evento?")) {
      await fetch(`http://localhost:3000/events/${id}`, { method: 'DELETE' });
      loadEvents();
    }
  };

  // Logout
  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("user");
    window.location.href = 'login.html';
  });

  loadEvents();
});